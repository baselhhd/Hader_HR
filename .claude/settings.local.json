{
  "permissions": {
    "allow": [
      "Bash(git add src/pages/employee/Profile.tsx src/pages/employee/LeaveRequest.tsx src/pages/employee/AttendanceHistory.tsx src/pages/employee/CustomRequest.tsx)",
      "Bash(git commit -m \"$(cat <<''EOF''\nfix: إصلاح صفحات الموظف - استبدال Supabase Auth بـ localStorage\n\n## 🐛 المشكلة:\nعند الضغط على صفحات الموظف (الملف الشخصي، طلب إجازة، سجل الحضور، طلب خاص)\nكان يحدث logout تلقائي وإعادة توجيه إلى صفحة تسجيل الدخول\n\n## 🔍 السبب:\nالصفحات كانت تستخدم `supabase.auth.getUser()` للتحقق من المستخدم\nلكن المشروع يستخدم localStorage للمصادقة (ليس Supabase Auth)\nلذلك `supabase.auth.getUser()` يُرجع null → redirect إلى /login\n\n## ✅ الحل:\nاستبدال Supabase Auth بـ `getSession()` من `@/lib/auth` في جميع الصفحات:\n\n### 1️⃣ Profile.tsx:\n- ✅ استبدال `supabase.auth.getUser()` بـ `getSession()`\n- ✅ استخدام `session.userId` بدلاً من `user.id`\n- ✅ التحقق من `session.role === ''employee''`\n\n### 2️⃣ LeaveRequest.tsx:\n- ✅ استبدال `supabase.auth.getSession()` بـ `getSession()`\n- ✅ استخدام `session.userId` بدلاً من `session.user.id`\n- ✅ التحقق من role قبل تحميل البيانات\n\n### 3️⃣ AttendanceHistory.tsx:\n- ✅ استبدال `supabase.auth.getSession()` بـ `getSession()`\n- ✅ استبدال `supabase.auth.getUser()` في `loadAttendance()`\n- ✅ استخدام `session.userId` في الاستعلامات\n\n### 4️⃣ CustomRequest.tsx:\n- ✅ كانت تستخدم `getSession()` لكن مع `session.id` (خطأ)\n- ✅ تصحيح إلى `session.userId` في مكانين:\n  - `fetchRequests()` - السطر 47\n  - `handleSubmit()` - السطر 78\n\n## 📝 التغييرات التقنية:\n\n### قبل:\n```typescript\nconst { data: { user } } = await supabase.auth.getUser();\nif (!user) {\n  navigate(\"/login\");\n  return;\n}\n```\n\n### بعد:\n```typescript\nconst session = getSession();\nif (!session) {\n  navigate(\"/login\");\n  return;\n}\n\nif (session.role !== \"employee\") {\n  toast.error(\"غير مصرح لك بالدخول\");\n  navigate(\"/employee/dashboard\");\n  return;\n}\n```\n\n## 🎯 النتيجة:\n- ✅ صفحة الملف الشخصي تعمل بشكل صحيح\n- ✅ صفحة طلب الإجازة تعمل بشكل صحيح\n- ✅ صفحة سجل الحضور تعمل بشكل صحيح\n- ✅ صفحة الطلب الخاص تعمل بشكل صحيح\n- ✅ لا يحدث logout عند الضغط على أي صفحة\n- ✅ التوافق الكامل مع نظام localStorage Auth\n\n## 📁 الملفات المعدلة (4):\n1. src/pages/employee/Profile.tsx\n2. src/pages/employee/LeaveRequest.tsx\n3. src/pages/employee/AttendanceHistory.tsx\n4. src/pages/employee/CustomRequest.tsx\n\n🤖 Generated with [Claude Code](https://claude.com/claude-code)\n\nCo-Authored-By: Claude <noreply@anthropic.com>\nEOF\n)\")"
    ],
    "deny": [],
    "ask": []
  }
}
