/**
 * Script to seed the database with test data
 * Run with: npx tsx scripts/seed-database.ts
 */

import { supabaseAdmin as supabase } from './_env-config';

/**
 * ÿ™ŸàŸÑŸäÿØ email ÿØÿßÿÆŸÑŸä ŸÖŸÜ username
 */
function generateInternalEmail(username: string): string {
  const cleanUsername = username.toLowerCase().trim().replace(/\s+/g, '_');
  return `${cleanUsername}@internal.hader.local`;
}

async function seedDatabase() {
  console.log('üå± Starting database seeding...\n');

  try {
    // 1. Create Company
    console.log('üìä Creating company...');
    const { data: company, error: companyError } = await supabase
      .from('companies')
      .insert({
        name: 'ÿ¥ÿ±ŸÉÿ© ÿßŸÑÿ£ŸÖŸÑ ŸÑŸÑÿ™ŸÉŸÜŸàŸÑŸàÿ¨Ÿäÿß',
        settings: {
          attendance_methods: {
            qr_code: { enabled: true, refresh_interval: 120, priority: 1 },
            color: { enabled: true, refresh_interval: 20, colors: ["red", "green", "blue", "yellow"], priority: 2 },
            code: { enabled: true, refresh_interval: 300, digits: 4, priority: 3 }
          },
          verification: {
            gps: { enabled: true, required: true, radius: 100 },
            selfie: { mode: "on_suspicion", face_recognition: false, liveness_detection: false }
          },
          suspicion: {
            enabled: true,
            gps_out_range: 40,
            unusual_time: 15,
            different_pattern: 10,
            previous_suspicious: 20,
            threshold: 50,
            verification_timeout: 20
          }
        }
      })
      .select()
      .single();

    if (companyError) throw companyError;
    console.log('‚úÖ Company created:', company.name);

    // 2. Create Branch
    console.log('\nüìç Creating branch...');
    const { data: branch, error: branchError } = await supabase
      .from('branches')
      .insert({
        company_id: company.id,
        name: 'ÿßŸÑŸÅÿ±ÿπ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä',
        address: 'ÿßŸÑÿ±Ÿäÿßÿ∂ÿå ÿ≠Ÿä ÿßŸÑÿπŸÑŸäÿß'
      })
      .select()
      .single();

    if (branchError) throw branchError;
    console.log('‚úÖ Branch created:', branch.name);

    // 3. Create Location
    console.log('\nüó∫Ô∏è Creating location...');
    const { data: location, error: locationError } = await supabase
      .from('locations')
      .insert({
        company_id: company.id,
        branch_id: branch.id,
        name: 'ÿßŸÑŸÖŸÉÿ™ÿ® ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä',
        address: 'ÿßŸÑÿ±Ÿäÿßÿ∂ÿå ÿ≠Ÿä ÿßŸÑÿπŸÑŸäÿßÿå ÿ¥ÿßÿ±ÿπ ÿßŸÑÿ™ÿ≠ŸÑŸäÿ©',
        lat: 24.7136, // Riyadh coordinates
        lng: 46.6753,
        gps_radius: 100
      })
      .select()
      .single();

    if (locationError) throw locationError;
    console.log('‚úÖ Location created:', location.name);

    // 4. Create Shift
    console.log('\n‚è∞ Creating shift...');
    const { data: shift, error: shiftError } = await supabase
      .from('shifts')
      .insert({
        location_id: location.id,
        name: 'ÿßŸÑŸàÿ±ÿØŸäÿ© ÿßŸÑÿµÿ®ÿßÿ≠Ÿäÿ©',
        start_time: '08:00:00',
        end_time: '16:00:00',
        break_start: '12:00:00',
        break_duration: 60,
        work_days: ["sun", "mon", "tue", "wed", "thu"],
        late_arrival_buffer: 15,
        work_hours: 8
      })
      .select()
      .single();

    if (shiftError) throw shiftError;
    console.log('‚úÖ Shift created:', shift.name);

    // 5. Create Users (using Supabase Auth)
    console.log('\nüë• Creating users...');

    // Employee User - check if exists first
    let employeeUserId: string;
    const employeeUsername = 'ahmed_ali';
    const employeeInternalEmail = generateInternalEmail(employeeUsername);

    const { data: existingEmployeeAuth } = await supabase.auth.admin.listUsers();
    const existingEmployee = existingEmployeeAuth.users.find(u => u.email === employeeInternalEmail);

    if (existingEmployee) {
      console.log('‚ÑπÔ∏è  Employee auth already exists, using existing user');
      employeeUserId = existingEmployee.id;
    } else {
      const { data: employeeAuth, error: employeeAuthError } = await supabase.auth.admin.createUser({
        email: employeeInternalEmail, // Email ÿØÿßÿÆŸÑŸä ŸÖŸèŸàŸÑÿØ
        password: 'Test123!',
        email_confirm: true
      });

      if (employeeAuthError) throw employeeAuthError;
      employeeUserId = employeeAuth.user.id;
      console.log(`‚úÖ Employee auth created with internal email: ${employeeInternalEmail}`);
    }

    // Check if profile exists
    const { data: existingProfile } = await supabase
      .from('users')
      .select('*')
      .eq('id', employeeUserId)
      .maybeSingle();

    let employeeProfile: typeof existingProfile;
    if (existingProfile) {
      console.log('‚ÑπÔ∏è  Employee profile already exists, updating...');
      const { data, error } = await supabase
        .from('users')
        .update({
          company_id: company.id,
          branch_id: branch.id
        })
        .eq('id', employeeUserId)
        .select()
        .single();

      if (error) throw error;
      employeeProfile = data;
    } else {
      // Insert employee profile
      const { data, error } = await supabase
        .from('users')
        .insert({
          id: employeeUserId,
          company_id: company.id,
          branch_id: branch.id,
          username: employeeUsername,
          email: null, // Email ÿ≠ŸÇŸäŸÇŸä ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ (ÿ≥Ÿäÿ∂ŸäŸÅŸá ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÑÿßÿ≠ŸÇÿßŸã ŸÖŸÜ ÿßŸÑÿ®ÿ±ŸàŸÅÿßŸäŸÑ)
          phone: '+966501234567',
          full_name: 'ÿ£ÿ≠ŸÖÿØ ÿπŸÑŸä ŸÖÿ≠ŸÖÿØ',
          role: 'employee'
        })
        .select()
        .single();

      if (error) throw error;
      employeeProfile = data;
      console.log('‚úÖ Employee profile created:', employeeProfile.full_name);
      console.log('   üìß Email: ÿØÿßÿÆŸÑŸä (ŸäŸÖŸÉŸÜ ÿ™ÿ≠ÿØŸäÿ´Ÿá ŸÖŸÜ ÿßŸÑÿ®ÿ±ŸàŸÅÿßŸäŸÑ)');
      console.log('   üì± Phone: +966501234567');
    }

    // Check if employee data exists
    const { data: existingEmpData } = await supabase
      .from('employees')
      .select('*')
      .eq('user_id', employeeUserId)
      .maybeSingle();

    if (existingEmpData) {
      console.log('‚ÑπÔ∏è  Employee data already exists, updating...');
      await supabase
        .from('employees')
        .update({
          location_id: location.id,
          shift_id: shift.id
        })
        .eq('user_id', employeeUserId);
    } else {
      // Insert employee data
      const { data: employee, error: employeeError } = await supabase
        .from('employees')
        .insert({
          user_id: employeeUserId,
          employee_number: 'EMP001',
          location_id: location.id,
          shift_id: shift.id,
          department: 'ÿ™ŸÇŸÜŸäÿ© ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™',
          position: 'ŸÖÿ∑Ÿàÿ± ÿ®ÿ±ŸÖÿ¨Ÿäÿßÿ™',
          hire_date: '2024-01-01',
          vacation_balance: 21,
          sick_leave_balance: 10
        })
        .select()
        .single();

      if (employeeError) throw employeeError;
      console.log('‚úÖ Employee data created:', employee.employee_number);
    }

    // Manager User - check if exists first
    let managerUserId: string;
    const managerUsername = 'khaled_manager';
    const managerInternalEmail = generateInternalEmail(managerUsername);
    const existingManager = existingEmployeeAuth.users.find(u => u.email === managerInternalEmail);

    if (existingManager) {
      console.log('‚ÑπÔ∏è  Manager auth already exists, using existing user');
      managerUserId = existingManager.id;
    } else {
      const { data: managerAuth, error: managerAuthError } = await supabase.auth.admin.createUser({
        email: managerInternalEmail, // Email ÿØÿßÿÆŸÑŸä ŸÖŸèŸàŸÑÿØ
        password: 'Test123!',
        email_confirm: true
      });

      if (managerAuthError) throw managerAuthError;
      managerUserId = managerAuth.user.id;
      console.log(`‚úÖ Manager auth created with internal email: ${managerInternalEmail}`);
    }

    // Check if profile exists
    const { data: existingManagerProfile } = await supabase
      .from('users')
      .select('*')
      .eq('id', managerUserId)
      .maybeSingle();

    if (!existingManagerProfile) {
      const { data: managerProfile, error: managerProfileError } = await supabase
        .from('users')
        .insert({
          id: managerUserId,
          company_id: company.id,
          branch_id: branch.id,
          username: managerUsername,
          email: 'khaled@company.com', // Email ÿ≠ŸÇŸäŸÇŸä ŸÉŸÖÿ´ÿßŸÑ
          phone: '+966507654321',
          full_name: 'ÿÆÿßŸÑÿØ ÿßŸÑŸÖÿØŸäÿ±',
          role: 'loc_manager'
        })
        .select()
        .single();

      if (managerProfileError) throw managerProfileError;
      console.log('‚úÖ Manager profile created:', managerProfile.full_name);
      console.log('   üìß Email: khaled@company.com (ÿ≠ŸÇŸäŸÇŸä)');
      console.log('   üì± Phone: +966507654321');
    } else {
      console.log('‚ÑπÔ∏è  Manager profile already exists');
    }

    // Assign manager to location
    const { data: existingLocManager } = await supabase
      .from('location_managers')
      .select('*')
      .eq('user_id', managerUserId)
      .eq('location_id', location.id)
      .maybeSingle();

    if (!existingLocManager) {
      const { error: locManagerError } = await supabase
        .from('location_managers')
        .insert({
          location_id: location.id,
          user_id: managerUserId
        });

      if (locManagerError) throw locManagerError;
      console.log('‚úÖ Manager assigned to location');
    } else {
      console.log('‚ÑπÔ∏è  Manager already assigned to location');
    }

    // HR Admin User - check if exists first
    let hrUserId: string;
    const hrUsername = 'fatima_hr';
    const hrInternalEmail = generateInternalEmail(hrUsername);
    const existingHR = existingEmployeeAuth.users.find(u => u.email === hrInternalEmail);

    if (existingHR) {
      console.log('‚ÑπÔ∏è  HR auth already exists, using existing user');
      hrUserId = existingHR.id;
    } else {
      const { data: hrAuth, error: hrAuthError } = await supabase.auth.admin.createUser({
        email: hrInternalEmail, // Email ÿØÿßÿÆŸÑŸä ŸÖŸèŸàŸÑÿØ
        password: 'Test123!',
        email_confirm: true
      });

      if (hrAuthError) throw hrAuthError;
      hrUserId = hrAuth.user.id;
      console.log(`‚úÖ HR auth created with internal email: ${hrInternalEmail}`);
    }

    // Check if profile exists
    const { data: existingHRProfile } = await supabase
      .from('users')
      .select('*')
      .eq('id', hrUserId)
      .maybeSingle();

    if (!existingHRProfile) {
      const { data: hrProfile, error: hrProfileError } = await supabase
        .from('users')
        .insert({
          id: hrUserId,
          company_id: company.id,
          branch_id: branch.id,
          username: hrUsername,
          email: null, // Email ÿ≠ŸÇŸäŸÇŸä ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)
          phone: null, // ÿ±ŸÇŸÖ ÿ¨ŸàÿßŸÑ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)
          full_name: 'ŸÅÿßÿ∑ŸÖÿ© ÿßŸÑŸÖŸàÿßÿ±ÿØ ÿßŸÑÿ®ÿ¥ÿ±Ÿäÿ©',
          role: 'hr_admin'
        })
        .select()
        .single();

      if (hrProfileError) throw hrProfileError;
      console.log('‚úÖ HR profile created:', hrProfile.full_name);
      console.log('   üìß Email: ÿØÿßÿÆŸÑŸä (ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿ´)');
      console.log('   üì± Phone: ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ');
    } else {
      console.log('‚ÑπÔ∏è  HR profile already exists');
    }

    // 6. Create some QR codes, color codes, numeric codes
    console.log('\nüîê Creating attendance codes...');

    // QR Code
    const { error: qrError } = await supabase
      .from('qr_codes')
      .insert({
        location_id: location.id,
        code_data: JSON.stringify({ locationId: location.id, timestamp: Date.now() }),
        expires_at: new Date(Date.now() + 2 * 60 * 1000).toISOString() // 2 minutes
      });

    if (qrError) throw qrError;
    console.log('‚úÖ QR code created');

    // Color Code
    const { error: colorError } = await supabase
      .from('color_codes')
      .insert({
        location_id: location.id,
        current_color: 'red',
        expires_at: new Date(Date.now() + 20 * 1000).toISOString() // 20 seconds
      });

    if (colorError) throw colorError;
    console.log('‚úÖ Color code created');

    // Numeric Code
    const { error: numericError } = await supabase
      .from('numeric_codes')
      .insert({
        location_id: location.id,
        code: '1234',
        expires_at: new Date(Date.now() + 5 * 60 * 1000).toISOString() // 5 minutes
      });

    if (numericError) throw numericError;
    console.log('‚úÖ Numeric code created');

    // 7. Create sample attendance record
    console.log('\nüìù Creating sample attendance record...');
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    yesterday.setHours(8, 15, 0, 0);

    const { error: attendanceError } = await supabase
      .from('attendance_records')
      .insert({
        company_id: company.id,
        branch_id: branch.id,
        location_id: location.id,
        employee_id: employeeUserId,
        shift_id: shift.id,
        check_in: yesterday.toISOString(),
        check_out: new Date(yesterday.getTime() + 8 * 60 * 60 * 1000).toISOString(),
        method_used: 'qr',
        status: 'approved',
        late_minutes: 15,
        work_hours: 8
      });

    if (attendanceError) throw attendanceError;
    console.log('‚úÖ Sample attendance record created');

    console.log('\n‚úÖ Database seeding completed successfully!\n');
    console.log('üìù Test Accounts Created (Username / Password):');
    console.log('‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê');
    console.log('‚îÇ üë§ Employee:  ahmed_ali / Test123!                         ‚îÇ');
    console.log('‚îÇ    üìß Email: ÿØÿßÿÆŸÑŸä (ŸäŸÖŸÉŸÜ ÿ™ÿ≠ÿØŸäÿ´Ÿá ŸÖŸÜ ÿßŸÑÿ®ÿ±ŸàŸÅÿßŸäŸÑ)             ‚îÇ');
    console.log('‚îÇ    üì± Phone: +966501234567                                  ‚îÇ');
    console.log('‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§');
    console.log('‚îÇ üëî Manager:   khaled_manager / Test123!                    ‚îÇ');
    console.log('‚îÇ    üìß Email: khaled@company.com (ÿ≠ŸÇŸäŸÇŸä)                    ‚îÇ');
    console.log('‚îÇ    üì± Phone: +966507654321                                  ‚îÇ');
    console.log('‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§');
    console.log('‚îÇ üíº HR Admin:  fatima_hr / Test123!                         ‚îÇ');
    console.log('‚îÇ    üìß Email: ÿØÿßÿÆŸÑŸä (ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿ´)                             ‚îÇ');
    console.log('‚îÇ    üì± Phone: ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ                                      ‚îÇ');
    console.log('‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò');
    console.log('\nüí° ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™:');
    console.log('   ‚Ä¢ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ Username + Password ŸÅŸÇÿ∑');
    console.log('   ‚Ä¢ Email Ÿà Phone ÿßÿÆÿ™Ÿäÿßÿ±ŸäŸäŸÜ ŸàŸäŸÖŸÉŸÜ ÿ™ÿ≠ÿØŸäÿ´ŸáŸÖÿß ŸÖŸÜ ÿßŸÑÿ®ÿ±ŸàŸÅÿßŸäŸÑ');
    console.log('   ‚Ä¢ Email ÿßŸÑÿØÿßÿÆŸÑŸä ÿ®ÿµŸäÿ∫ÿ©: {username}@internal.hader.local');
    console.log('   ‚Ä¢ ŸäŸÖŸÉŸÜ ÿ™ÿ≠ÿØŸäÿ´ Email ŸÖŸÜ ÿØÿßÿÆŸÑŸä ÿ•ŸÑŸâ ÿ≠ŸÇŸäŸÇŸä ŸÅŸä ÿ£Ÿä ŸàŸÇÿ™\n');

  } catch (error) {
    const message = error instanceof Error ? error.message : 'Unknown error';
    console.error('‚ùå Error seeding database:', message);
    console.error(error);
  }
}

seedDatabase();
